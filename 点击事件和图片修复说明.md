# é¢„è§ˆæ¨¡å¼å®Œæ•´ä¿®å¤ - ç‚¹å‡»äº‹ä»¶å’Œå›¾ç‰‡åŠ è½½

**ä¿®å¤æ—¶é—´**: 2026-01-27 å‡Œæ™¨2:18
**é—®é¢˜**:
1. âŒ ç‚¹å‡»æŒ‰é’®æ²¡æœ‰ååº”
2. âŒ å›¾ç‰‡æ— æ³•æ˜¾ç¤º
3. âš ï¸ è¿˜æ˜¾ç¤º"æ— ç©å®¶è§’è‰²"è­¦å‘Š

## ä¿®å¤å†…å®¹

### 1. æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç† âœ…

#### é—®é¢˜
- ç»„ä»¶æ¸²æŸ“æ—¶æ²¡æœ‰ç»‘å®šonClickäº‹ä»¶
- GameEngineç¼ºå°‘handleClickæ–¹æ³•

#### è§£å†³æ–¹æ¡ˆ

**GamePreview.tsx**:
```typescript
// ä¸ºæ¯ä¸ªç»„ä»¶æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
const handleClick = (e: React.MouseEvent) => {
  e.stopPropagation();
  console.log('[GamePreview] ç»„ä»¶è¢«ç‚¹å‡»:', component.name, component.id);

  // é€šçŸ¥æ¸¸æˆå¼•æ“è§¦å‘ç‚¹å‡»äº‹ä»¶
  if (engineRef.current) {
    engineRef.current.handleClick(component.id);
  }
};

// åœ¨æ¸²æŸ“æ—¶ç»‘å®šäº‹ä»¶
<div key={component.id} style={style} onClick={handleClick}>
  {renderContent()}
</div>
```

**GameEngine.ts**:
```typescript
/**
 * å¤„ç†ç‚¹å‡»äº‹ä»¶
 */
handleClick(objectId: string): void {
  console.log('[GameEngine] handleClick called for:', objectId);

  // è§¦å‘ç‚¹å‡»äº‹ä»¶
  this.eventSystem.emit(GameEvents.INPUT_CLICK, { objectId });

  // æ‰¾åˆ°è¢«ç‚¹å‡»çš„æ¸¸æˆå¯¹è±¡
  const clickedObject = this.stateManager.getAllGameObjects()
    .find(obj => obj.id === objectId);

  if (clickedObject) {
    // è§¦å‘ onClick è„šæœ¬
    clickedObject.scripts
      .filter((s) => s.enabled && s.trigger === 'onClick')
      .forEach((script) => {
        const context: ExecutionContext = {
          gameObject: clickedObject,
          gameState: this.stateManager.getState(),
          event: {
            type: 'click',
            data: { objectId },
            timestamp: Date.now(),
          },
          localVariables: {},
        };
        this.blockExecutor.executeBlocks(script.blocks, context);
      });
  }
}
```

### 2. ä¿®å¤å›¾ç‰‡åŠ è½½ âœ…

#### é—®é¢˜
- å›¾ç‰‡è·¯å¾„å¯èƒ½ä¸æ­£ç¡®
- æ²¡æœ‰é”™è¯¯å¤„ç†
- `imageRendering: 'pixelated'` å¯èƒ½å¯¼è‡´æŸäº›æµè§ˆå™¨æ¸²æŸ“é—®é¢˜

#### è§£å†³æ–¹æ¡ˆ

```typescript
case 'image':
  return component.props.src ? (
    <img
      src={component.props.src as string}
      alt=""
      style={{
        width: '100%',
        height: '100%',
        objectFit: component.props.mode as string || 'cover',
        imageRendering: 'auto',  // ä»pixelatedæ”¹ä¸ºauto
        display: 'block',
      }}
      onError={(e) => {
        console.error('[GamePreview] å›¾ç‰‡åŠ è½½å¤±è´¥:', component.props.src);
        // æ˜¾ç¤ºå ä½ç¬¦
        e.currentTarget.style.display = 'none';
        e.currentTarget.parentElement!.style.background = '#f0f0f0';
        e.currentTarget.parentElement!.innerHTML =
          '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:12px;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
      }}
    />
  ) : (
    <div style={{ /* ...å ä½ç¬¦æ ·å¼... */ }}>å›¾ç‰‡å ä½</div>
  );
```

### 3. æ·»åŠ å…‰æ ‡æ ·å¼ âœ…

æ‰€æœ‰å¯äº¤äº’ç»„ä»¶æ·»åŠ  `cursor: 'pointer'`ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

## ä½¿ç”¨æ–¹æ³•

### é‡è¦æç¤º
**æœåŠ¡å™¨å·²åˆ‡æ¢åˆ°æ–°ç«¯å£ï¼**

æ—§åœ°å€: ~~http://localhost:3000~~ (å·²åœæ­¢)
**æ–°åœ°å€**: **http://localhost:3001** âœ…

### æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°æµè§ˆå™¨**
   ```
   è®¿é—®: http://localhost:3001
   æˆ–: http://192.168.1.22:3001
   ```

2. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·** (F12)
   - åˆ‡æ¢åˆ°Consoleæ ‡ç­¾
   - æŸ¥çœ‹è°ƒè¯•æ—¥å¿—

3. **æµ‹è¯•ç‚¹å‡»äº‹ä»¶**
   ```
   åœºæ™¯ï¼šå¼€åœºèœå•
   ç»„ä»¶ï¼šå¼€å§‹æ¸¸æˆæŒ‰é’®
   ç§¯æœ¨ï¼ševent_click â†’ state_gotoscene(scene: 'ç¬¬ä¸€å…³')
   ```

4. **ç‚¹å‡»æŒ‰é’®æ—¶åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—**:
   ```
   [GamePreview] ç»„ä»¶è¢«ç‚¹å‡»: å¼€å§‹æŒ‰é’® comp-xxx
   [GameEngine] handleClick called for: comp-xxx
   [GameEngine] Found clicked object: å¼€å§‹æŒ‰é’® - scripts: 1
   [GameEngine] Checking script: onClick enabled: true
   [GameEngine] Executing onClick script with 1 blocks
   [BlockExecutor] Executing block: state_gotoscene
   ```

5. **æ£€æŸ¥å›¾ç‰‡åŠ è½½**
   - å¦‚æœå›¾ç‰‡æ­£å¸¸æ˜¾ç¤º â†’ âœ… æ²¡é—®é¢˜
   - å¦‚æœæ˜¾ç¤º"å›¾ç‰‡åŠ è½½å¤±è´¥" â†’ æ£€æŸ¥å›¾ç‰‡è·¯å¾„
   - æŒ‰F12æŸ¥çœ‹Consoleä¸­çš„é”™è¯¯ä¿¡æ¯

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ç‚¹å‡»è¿˜æ˜¯æ²¡ååº”ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
```
1. ç¡®è®¤è®¿é—®çš„æ˜¯ http://localhost:3001 (æ–°ç«¯å£)
2. æŒ‰Ctrl+Shift+Rå¼ºåˆ¶åˆ·æ–°æ¸…é™¤ç¼“å­˜
3. æ‰“å¼€F12æ£€æŸ¥Consoleæ˜¯å¦æœ‰æ—¥å¿—
4. ç¡®è®¤ç§¯æœ¨çš„triggeræ˜¯'onClick'è€Œä¸æ˜¯'event_click'
```

**æŸ¥çœ‹ç§¯æœ¨é…ç½®**:
- åœ¨ç¼–è¾‘å™¨ä¸­é€‰ä¸­æŒ‰é’®
- å³ä¾§é¢æ¿æ£€æŸ¥"é€»è¾‘ç§¯æœ¨"
- ç¡®è®¤æœ‰"å½“ç‚¹å‡»æ—¶"äº‹ä»¶ç§¯æœ¨

### Q2: å›¾ç‰‡æ˜¾ç¤º"åŠ è½½å¤±è´¥"ï¼Ÿ

**å¯èƒ½çš„åŸå› **:
```
1. å›¾ç‰‡è·¯å¾„é”™è¯¯
   - ç›¸å¯¹è·¯å¾„: ./images/bg.png
   - ç»å¯¹è·¯å¾„: /src/assets/bg.png
   - ç½‘ç»œè·¯å¾„: https://example.com/image.png

2. å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨
   - æ£€æŸ¥publicæ–‡ä»¶å¤¹
   - æ£€æŸ¥src/assetsæ–‡ä»¶å¤¹

3. è·¨åŸŸé—®é¢˜ (ç½‘ç»œå›¾ç‰‡)
   - å›¾ç‰‡æœåŠ¡å™¨ä¸å…è®¸è·¨åŸŸè®¿é—®
```

**è§£å†³æ–¹æ³•**:
```typescript
// æ–¹å¼1: æ”¾åœ¨publicæ–‡ä»¶å¤¹
å›¾ç‰‡è·¯å¾„: /images/bg.png
å®é™…ä½ç½®: E:\æœ€æ–°\æœ€ç»ˆèåˆç‰ˆ_20260127\åˆ›å®¢new\åˆ›å®¢\public\images\bg.png

// æ–¹å¼2: ä½¿ç”¨import (æ¨è)
import bgImage from '@/assets/bg.png'
å›¾ç‰‡è·¯å¾„: bgImage (è¿™æ˜¯ä¸ªå˜é‡)

// æ–¹å¼3: ä½¿ç”¨ç½‘ç»œå›¾ç‰‡ (æ³¨æ„è·¨åŸŸ)
å›¾ç‰‡è·¯å¾„: https://picsum.photos/200/300
```

### Q3: åœºæ™¯åˆ‡æ¢ä¸å·¥ä½œï¼Ÿ

**æ£€æŸ¥åœºæ™¯åç§°**:
```typescript
// ç§¯æœ¨é…ç½®
ç§¯æœ¨ç±»å‹: state_gotoscene
å‚æ•°: scene = "ç¬¬ä¸€å…³"  // â† å¿…é¡»ä¸å®é™…åœºæ™¯åç§°å®Œå…¨åŒ¹é…

// åœ¨é¡¹ç›®ä¸­æ£€æŸ¥
å·¦ä¾§é¢æ¿ â†’ é¡µé¢åˆ—è¡¨ â†’ ç¡®è®¤åœºæ™¯åç§°
```

## è°ƒè¯•æŠ€å·§

### æ‰“å¼€è¯¦ç»†æ—¥å¿—

æµè§ˆå™¨Consoleä¸­çš„æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
âœ… ç‚¹å‡»äº‹ä»¶: [GamePreview] ç»„ä»¶è¢«ç‚¹å‡»
âœ… å¼•æ“å¤„ç†: [GameEngine] handleClick called
âœ… è„šæœ¬æŸ¥æ‰¾: [GameEngine] Found clicked object
âœ… ç§¯æœ¨æ‰§è¡Œ: [BlockExecutor] Executing block
âŒ å›¾ç‰‡é”™è¯¯: [GamePreview] å›¾ç‰‡åŠ è½½å¤±è´¥
```

### æ£€æŸ¥ç§¯æœ¨æ‰§è¡Œ

å¦‚æœç‚¹å‡»æœ‰ååº”ä½†æ²¡æœ‰æ•ˆæœï¼š
1. æ£€æŸ¥ç§¯æœ¨ç±»å‹æ˜¯å¦æ­£ç¡® (`state_gotoscene`)
2. æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡® (`scene: "åœºæ™¯å"`)
3. æ£€æŸ¥ç›®æ ‡åœºæ™¯æ˜¯å¦å­˜åœ¨

## ä¿®æ”¹çš„æ–‡ä»¶

1. **src/components/preview/GamePreview.tsx**
   - æ·»åŠ handleClickäº‹ä»¶å¤„ç†
   - æ·»åŠ cursoræ ·å¼
   - æ”¹è¿›å›¾ç‰‡é”™è¯¯å¤„ç†

2. **src/engine/GameEngine.ts**
   - æ·»åŠ handleClickæ–¹æ³•
   - è§¦å‘onClickè„šæœ¬æ‰§è¡Œ

## æŠ€æœ¯ç»†èŠ‚

### äº‹ä»¶æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
  â†“
GamePreview.handleClick (é˜»æ­¢å†’æ³¡)
  â†“
GameEngine.handleClick (é€šè¿‡componentId)
  â†“
æŸ¥æ‰¾GameObject
  â†“
ç­›é€‰onClickè„šæœ¬
  â†“
BlockExecutor.executeBlocks
  â†“
æ‰§è¡Œç§¯æœ¨é€»è¾‘ (å¦‚: åˆ‡æ¢åœºæ™¯)
```

### æ”¯æŒçš„äº‹ä»¶è§¦å‘å™¨

```typescript
// ç°åœ¨æ”¯æŒçš„è§¦å‘å™¨
- 'onClick'     // ç‚¹å‡»äº‹ä»¶ âœ… åˆšä¿®å¤
- 'onKeyDown'   // æŒ‰é”®æŒ‰ä¸‹ âœ… å·²æœ‰
- 'onKeyUp'     // æŒ‰é”®æ¾å¼€ âœ… å·²æœ‰
- 'onGameStart' // æ¸¸æˆå¼€å§‹ âœ… å·²æœ‰
- 'onUpdate'    // æ¯å¸§æ›´æ–° âœ… å·²æœ‰
```

---

**ç°åœ¨ç‚¹å‡»äº‹ä»¶åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œäº†ï¼**

**è®¿é—®æ–°åœ°å€æµ‹è¯•**: http://localhost:3001 ğŸ®
