# é¢„è§ˆæ¨¡å¼ç©ºç™½é—®é¢˜ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¶é—´**: 2026-01-27 å‡Œæ™¨2:44
**é—®é¢˜**: æ·»åŠ åœºæ™¯åˆ‡æ¢åŠŸèƒ½åï¼Œé¢„è§ˆæ¨¡å¼æ— æ³•æ˜¾ç¤ºæ¸¸æˆç”»é¢

## é—®é¢˜æ ¹æº

### âŒ åŸæœ‰ä»£ç ç»“æ„

```typescript
useEffect(() => {
  if (!currentPage) return;

  if (!engineRef.current) {
    // 1. åˆå§‹åŒ–å¼•æ“
    engineRef.current = new GameEngine({...});

    // 2. æ³¨å†Œåœºæ™¯åˆ‡æ¢ç›‘å¬å™¨
    engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, (data) => {
      setCurrentPage(sceneId); // è§¦å‘ useEffect é‡æ–°æ‰§è¡Œ
    });

    // 3. åŠ è½½åœºæ™¯
    engineRef.current.loadScene(currentPage);

    // 4. å¯åŠ¨å¼•æ“
    engineRef.current.start();

    // 5. åˆå§‹åŒ–ç©å®¶/æ•Œäºº
    ...
  } // <- å…³é”®é—®é¢˜ï¼šæ‰€æœ‰é€»è¾‘éƒ½åœ¨è¿™ä¸ª if å—å†…

  return () => {...};
}, [currentPage]);
```

**é—®é¢˜**:
1. åœºæ™¯åˆ‡æ¢æ—¶ï¼Œ`setCurrentPage(sceneId)` è¢«è°ƒç”¨
2. è¿™ä¼šè§¦å‘ `useEffect` é‡æ–°æ‰§è¡Œ
3. ä½†æ­¤æ—¶ `engineRef.current` å·²å­˜åœ¨ï¼Œæ‰€ä»¥ `if (!engineRef.current)` ä¸º false
4. æ•´ä¸ª if å—è¢«è·³è¿‡ï¼Œåœºæ™¯æ²¡æœ‰é‡æ–°åŠ è½½
5. é¢„è§ˆç”»é¢ä¿æŒç©ºç™½

**å¦ä¸€ä¸ªè¯­æ³•é”™è¯¯**:
```typescript
if (playerComponent) {
  ...
} else {
  ...
}
} // <- å¤šä½™çš„é—­åˆæ‹¬å·å¯¼è‡´è¯­æ³•é”™è¯¯
```

## è§£å†³æ–¹æ¡ˆ

### âœ… ä¿®å¤åçš„ä»£ç ç»“æ„

```typescript
useEffect(() => {
  if (!currentPage) return;

  // 1. åˆå§‹åŒ–å¼•æ“ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
  if (!engineRef.current) {
    engineRef.current = new GameEngine({
      targetFPS: 60,
      gravity: { x: 0, y: 0 },
      debug: false,
      showFPS: false,
      showColliders: false,
    });

    // ç›‘å¬åœºæ™¯åˆ‡æ¢äº‹ä»¶ï¼ˆåªæ³¨å†Œä¸€æ¬¡ï¼‰
    engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, (data: any) => {
      console.log('[GamePreview] åœºæ™¯åˆ‡æ¢äº‹ä»¶è§¦å‘:', data);
      const { sceneId } = data;

      if (sceneId) {
        console.log('[GamePreview] æ­£åœ¨åˆ‡æ¢åˆ°åœºæ™¯:', sceneId);
        setCurrentPage(sceneId);
      }
    });

    console.log('[GamePreview] æ¸¸æˆå¼•æ“å·²åˆ›å»º');
  }

  // 2. åŠ è½½å½“å‰åœºæ™¯ï¼ˆæ¯æ¬¡åœºæ™¯å˜åŒ–éƒ½æ‰§è¡Œï¼‰
  console.log('[GamePreview] åŠ è½½åœºæ™¯:', currentPage.name, currentPage.id);
  engineRef.current.loadScene(currentPage);

  // 3. å¯åŠ¨å¼•æ“ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
  if (!engineRef.current.isRunning()) {  // æ³¨æ„ï¼šisRunning æ˜¯æ–¹æ³•ï¼Œä¸æ˜¯å±æ€§
    engineRef.current.start();
    console.log('[GamePreview] æ¸¸æˆå¼•æ“å·²å¯åŠ¨');
  }

  // 4. åˆå§‹åŒ–ç©å®¶å’Œæ•Œäººï¼ˆæ¯æ¬¡åœºæ™¯å˜åŒ–éƒ½æ‰§è¡Œï¼‰
  const playerComponent = currentPage.components.find(
    comp => comp.gameRole?.roleType === 'player'
  );

  const enemyPositions = new Map<string, { x: number; y: number }>();
  currentPage.components.forEach(comp => {
    if (comp.gameRole?.roleType === 'enemy') {
      enemyPositions.set(comp.id, { ...comp.position });
    }
  });

  if (playerComponent) {
    // åˆå§‹åŒ–ç©å®¶çŠ¶æ€
    ...
  } else {
    // åˆå§‹åŒ–æ— ç©å®¶åœºæ™¯
    ...
  }

  // 5. æ¸…ç†å‡½æ•°ï¼šåœæ­¢å¼•æ“
  return () => {
    if (engineRef.current) {
      engineRef.current.stop();
      engineRef.current = null;
    }
  };
}, [currentPage]);
```

## å…³é”®æ”¹åŠ¨

### 1. åˆ†ç¦»å¼•æ“åˆå§‹åŒ–å’Œåœºæ™¯åŠ è½½

**ä¹‹å‰**:
```typescript
if (!engineRef.current) {
  // å¼•æ“åˆå§‹åŒ–
  // åœºæ™¯åŠ è½½
  // å¼•æ“å¯åŠ¨
  // ç©å®¶åˆå§‹åŒ–
}
// â† åœºæ™¯åˆ‡æ¢æ—¶ï¼Œè¿™é‡Œä»€ä¹ˆéƒ½ä¸æ‰§è¡Œ
```

**ä¹‹å**:
```typescript
// å¼•æ“åˆå§‹åŒ–ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
if (!engineRef.current) {
  engineRef.current = new GameEngine({...});
  engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, ...);
}

// åœºæ™¯åŠ è½½ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼‰â† å…³é”®ï¼
engineRef.current.loadScene(currentPage);

// å¼•æ“å¯åŠ¨ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
if (!engineRef.current.isRunning()) {
  engineRef.current.start();
}

// ç©å®¶åˆå§‹åŒ–ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼‰
const playerComponent = ...;
```

### 2. ä¿®å¤è¯­æ³•é”™è¯¯

**ç§»é™¤äº†å¤šä½™çš„é—­åˆæ‹¬å·**:
```typescript
// ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰
if (playerComponent) {
  ...
} else {
  ...
}
} // â† å¤šä½™çš„æ‹¬å·

return () => {...};
```

```typescript
// ä¹‹åï¼ˆæ­£ç¡®ï¼‰
if (playerComponent) {
  ...
} else {
  ...
}

return () => {...};
```

### 3. ä¿®å¤ isRunning è°ƒç”¨

**ä¹‹å‰**:
```typescript
if (!engineRef.current.isRunning) {  // âŒ å½“ä½œå±æ€§è®¿é—®
  engineRef.current.start();
}
```

**ä¹‹å**:
```typescript
if (!engineRef.current.isRunning()) {  // âœ… è°ƒç”¨æ–¹æ³•
  engineRef.current.start();
}
```

## æ‰§è¡Œæµç¨‹

### é¦–æ¬¡è¿›å…¥é¢„è§ˆæ¨¡å¼

1. `useEffect` æ‰§è¡Œï¼Œ`engineRef.current` ä¸º null
2. åˆ›å»º GameEngine å®ä¾‹
3. æ³¨å†Œåœºæ™¯åˆ‡æ¢ç›‘å¬å™¨
4. **åŠ è½½å½“å‰åœºæ™¯**
5. å¯åŠ¨å¼•æ“
6. åˆå§‹åŒ–ç©å®¶/æ•ŒäººçŠ¶æ€
7. æ¸²æŸ“æ¸¸æˆç”»é¢ âœ…

### åœºæ™¯åˆ‡æ¢æ—¶

1. ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
2. ç§¯æœ¨ç³»ç»Ÿå‘å‡º `SCENE_CHANGE` äº‹ä»¶
3. ç›‘å¬å™¨è°ƒç”¨ `setCurrentPage(newSceneId)`
4. `useEffect` é‡æ–°æ‰§è¡Œ
5. `engineRef.current` å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–
6. **é‡æ–°åŠ è½½æ–°åœºæ™¯** â† å…³é”®æ­¥éª¤
7. å¼•æ“å·²è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨
8. åˆå§‹åŒ–æ–°åœºæ™¯çš„ç©å®¶/æ•Œäºº
9. æ¸²æŸ“æ–°åœºæ™¯ç”»é¢ âœ…

### é€€å‡ºé¢„è§ˆæ¨¡å¼

1. ç»„ä»¶å¸è½½
2. æ¸…ç†å‡½æ•°æ‰§è¡Œ
3. åœæ­¢å¼•æ“ï¼š`engineRef.current.stop()`
4. æ¸…ç©ºå¼•ç”¨ï¼š`engineRef.current = null`

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

2. **åˆ›å»ºæµ‹è¯•åœºæ™¯**
   - åœºæ™¯1: èœå•ç•Œé¢ï¼ˆæ— ç©å®¶è§’è‰²ï¼‰
   - åœºæ™¯2: æ¸¸æˆåœºæ™¯ï¼ˆæœ‰ç©å®¶è§’è‰²ï¼‰

3. **è®¾ç½®åœºæ™¯åˆ‡æ¢**
   - åœ¨åœºæ™¯1æ·»åŠ æŒ‰é’®
   - ä½¿ç”¨AIåŠ©æ‰‹ç”Ÿæˆç§¯æœ¨ï¼š
     ```
     å½“ç‚¹å‡»æ—¶ â†’ è·³è½¬åœºæ™¯(åœºæ™¯2çš„ID)
     ```

4. **æµ‹è¯•é¢„è§ˆæ¨¡å¼**
   - ç‚¹å‡»é¢„è§ˆæŒ‰é’®
   - åº”è¯¥çœ‹åˆ°åœºæ™¯1æ­£å¸¸æ˜¾ç¤º
   - æ‰“å¼€F12æŸ¥çœ‹Consoleæ—¥å¿—

5. **æµ‹è¯•åœºæ™¯åˆ‡æ¢**
   - ç‚¹å‡»åœºæ™¯1çš„æŒ‰é’®
   - åº”è¯¥åˆ‡æ¢åˆ°åœºæ™¯2
   - åœºæ™¯2åº”è¯¥æ­£å¸¸æ˜¾ç¤º

### é¢„æœŸæ—¥å¿—

```
[GamePreview] æ¸¸æˆå¼•æ“å·²åˆ›å»º
[GamePreview] åŠ è½½åœºæ™¯: èœå•ç•Œé¢ page-xxx
[GameEngine] Loading scene: èœå•ç•Œé¢
[GamePreview] æ¸¸æˆå¼•æ“å·²å¯åŠ¨

// ç‚¹å‡»æŒ‰é’®å
[GamePreview] ç»„ä»¶è¢«ç‚¹å‡»: å¼€å§‹æŒ‰é’® comp-xxx
[GameEngine] handleClick called for: comp-xxx
[BlockExecutor] Executing block: state_gotoscene
[GamePreview] åœºæ™¯åˆ‡æ¢äº‹ä»¶è§¦å‘: { sceneId: "page-yyy" }
[GamePreview] æ­£åœ¨åˆ‡æ¢åˆ°åœºæ™¯: page-yyy
[GamePreview] åŠ è½½åœºæ™¯: æ¸¸æˆåœºæ™¯ page-yyy
[GameEngine] Loading scene: æ¸¸æˆåœºæ™¯
```

### é¢„æœŸæ•ˆæœ

âœ… é¢„è§ˆæ¨¡å¼æ­£å¸¸æ˜¾ç¤ºåˆå§‹åœºæ™¯
âœ… ç‚¹å‡»æŒ‰é’®æˆåŠŸåˆ‡æ¢åœºæ™¯
âœ… æ–°åœºæ™¯æ­£å¸¸æ˜¾ç¤º
âœ… æ— ç©å®¶åœºæ™¯ä¸æ˜¾ç¤ºè­¦å‘Š
âœ… æœ‰ç©å®¶åœºæ™¯å¯ä»¥ç”¨WASDæ§åˆ¶
âœ… Consoleæ— é”™è¯¯

## æŠ€æœ¯è¦ç‚¹

### 1. useEffect ä¾èµ–æ•°ç»„

```typescript
useEffect(() => {
  // å½“ currentPage å˜åŒ–æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šé‡æ–°æ‰§è¡Œ
  ...
}, [currentPage]); // â† ä¾èµ– currentPage
```

**å…³é”®ç†è§£**:
- `currentPage` å˜åŒ– â†’ useEffect é‡æ–°æ‰§è¡Œ
- åœºæ™¯åˆ‡æ¢æ—¶ `setCurrentPage` â†’ currentPage å˜åŒ– â†’ useEffect æ‰§è¡Œ
- æ‰€ä»¥åœºæ™¯åŠ è½½é€»è¾‘å¿…é¡»åœ¨ if å—å¤–éƒ¨

### 2. å¼•æ“ç”Ÿå‘½å‘¨æœŸç®¡ç†

```typescript
// åˆå§‹åŒ–ï¼ˆä¸€æ¬¡ï¼‰
if (!engineRef.current) {
  engineRef.current = new GameEngine();
}

// åœºæ™¯æ“ä½œï¼ˆå¤šæ¬¡ï¼‰
engineRef.current.loadScene(scene);

// å¯åŠ¨æ£€æŸ¥ï¼ˆæ¡ä»¶ï¼‰
if (!engineRef.current.isRunning()) {
  engineRef.current.start();
}

// æ¸…ç†ï¼ˆå¸è½½æ—¶ï¼‰
return () => {
  engineRef.current.stop();
  engineRef.current = null;
};
```

### 3. äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œæ—¶æœº

```typescript
// âœ… æ­£ç¡®ï¼šåªåœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œä¸€æ¬¡
if (!engineRef.current) {
  engineRef.current = new GameEngine();
  engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, handler);
}

// âŒ é”™è¯¯ï¼šæ¯æ¬¡ useEffect éƒ½æ³¨å†Œ
engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, handler);
// è¿™ä¼šå¯¼è‡´åŒä¸€äº‹ä»¶è¢«å¤šæ¬¡å¤„ç†
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆåœºæ™¯åˆ‡æ¢åç”»é¢ç©ºç™½ï¼Ÿ

**åŸå› **: åœºæ™¯åŠ è½½é€»è¾‘åœ¨ `if (!engineRef.current)` å†…éƒ¨

**è§£å†³**: å°† `loadScene` ç§»åˆ° if å—å¤–éƒ¨

### Q2: ä¸ºä»€ä¹ˆä¼šæç¤º "isRunning is not a function"ï¼Ÿ

**åŸå› **: `isRunning` æ˜¯æ–¹æ³•ï¼Œä¸æ˜¯å±æ€§

**è§£å†³**: ä½¿ç”¨ `isRunning()` è€Œä¸æ˜¯ `isRunning`

### Q3: ä¸ºä»€ä¹ˆåœºæ™¯åˆ‡æ¢è§¦å‘å¤šæ¬¡ï¼Ÿ

**åŸå› **: äº‹ä»¶ç›‘å¬å™¨è¢«é‡å¤æ³¨å†Œ

**è§£å†³**: åªåœ¨å¼•æ“åˆå§‹åŒ–æ—¶æ³¨å†Œä¸€æ¬¡ï¼ˆåœ¨ if å—å†…ï¼‰

### Q4: åœºæ™¯åˆ‡æ¢åæ§åˆ¶å¤±æ•ˆï¼Ÿ

**åŸå› **: ç©å®¶çŠ¶æ€æ²¡æœ‰é‡æ–°åˆå§‹åŒ–

**è§£å†³**: ç©å®¶/æ•Œäººåˆå§‹åŒ–é€»è¾‘åœ¨ if å—å¤–éƒ¨ï¼Œæ¯æ¬¡åœºæ™¯å˜åŒ–éƒ½æ‰§è¡Œ

## ç›¸å…³æ–‡ä»¶

1. **GamePreview.tsx** (æœ¬æ¬¡ä¿®æ”¹)
   - `E:\æœ€æ–°\æœ€ç»ˆèåˆç‰ˆ_20260127\åˆ›å®¢new\åˆ›å®¢\src\components\preview\GamePreview.tsx`
   - Lines 40-122: useEffect åœºæ™¯ç®¡ç†é€»è¾‘

2. **GameEngine.ts**
   - `E:\æœ€æ–°\æœ€ç»ˆèåˆç‰ˆ_20260127\åˆ›å®¢new\åˆ›å®¢\src\engine\GameEngine.ts`
   - Line 619: `isRunning()` æ–¹æ³•å®šä¹‰

3. **BlockExecutor.ts**
   - `E:\æœ€æ–°\æœ€ç»ˆèåˆç‰ˆ_20260127\åˆ›å®¢new\åˆ›å®¢\src\engine\BlockExecutor.ts`
   - Line 1409: `state_gotoscene` ç§¯æœ¨å®ç°

4. **EventSystem.ts**
   - `E:\æœ€æ–°\æœ€ç»ˆèåˆç‰ˆ_20260127\åˆ›å®¢new\åˆ›å®¢\src\engine\EventSystem.ts`
   - `GameEvents.SCENE_CHANGE` äº‹ä»¶å®šä¹‰

## åç»­ä¼˜åŒ–

### 1. æ·»åŠ åœºæ™¯åˆ‡æ¢åŠ¨ç”»

```typescript
// åœ¨ setCurrentPage å‰æ·»åŠ æ·¡å‡ºæ•ˆæœ
await fadeOut();
setCurrentPage(sceneId);
await fadeIn();
```

### 2. åœºæ™¯é¢„åŠ è½½

```typescript
// é¢„åŠ è½½å³å°†è®¿é—®çš„åœºæ™¯
const nextScene = getNextScene(currentPage);
if (nextScene) {
  preloadScene(nextScene);
}
```

### 3. åœºæ™¯åˆ‡æ¢å†å²

```typescript
const sceneHistory: string[] = [];

// åˆ‡æ¢æ—¶è®°å½•
sceneHistory.push(currentPage.id);

// è¿”å›ä¸Šä¸€åœºæ™¯
const previousScene = sceneHistory.pop();
if (previousScene) {
  setCurrentPage(previousScene);
}
```

---

**ä¿®å¤å®Œæˆï¼é¢„è§ˆæ¨¡å¼ç°åœ¨åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚** ğŸ‰

**é‡è¦æé†’**:
1. åˆ·æ–°é¡µé¢ (Ctrl + Shift + R)
2. æ‰“å¼€F12æŸ¥çœ‹Consoleæ—¥å¿—
3. æµ‹è¯•é¢„è§ˆæ¨¡å¼
4. æµ‹è¯•åœºæ™¯åˆ‡æ¢åŠŸèƒ½

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›Consoleä¸­çš„å®Œæ•´æ—¥å¿—ï¼
