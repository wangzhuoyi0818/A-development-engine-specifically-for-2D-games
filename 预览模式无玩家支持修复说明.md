# 预览模式支持无玩家场景 - 修复说明

**修复时间**: 2026-01-27 凌晨2:09
**问题**: 预览模式强制要求玩家角色，导致菜单、开场等场景无法预览

## 问题描述

用户在制作开场界面时，添加了按钮切换场景的逻辑。但进入预览模式后显示：
```
⚠️ 未找到玩家角色
```

**问题根源**：
- 原代码在 `gameLoop` 中强制检查玩家：`if (!playerComponentRef.current || !currentPage) return;`
- 这导致没有玩家角色的场景完全无法运行
- 很多游戏场景确实不需要玩家（菜单、结束画面、过场动画等）

## 修复内容

### 1. 游戏循环逻辑优化

**修改文件**: `src/components/preview/GamePreview.tsx`

#### 修改前
```typescript
const gameLoop = useCallback(() => {
  if (!playerComponentRef.current || !currentPage) return;  // ❌ 强制要求玩家
  // ...所有游戏逻辑
}, [currentPage]);
```

#### 修改后
```typescript
const gameLoop = useCallback(() => {
  if (!currentPage) return;  // ✅ 只检查页面存在

  // 从引擎获取游戏对象
  if (engineRef.current) {
    gameObjectsRef.current = engineRef.current.getGameObjects();
  }

  // 如果有玩家角色，处理玩家相关逻辑
  if (playerComponentRef.current) {
    // 玩家移动、摄像机跟随、敌人追踪等
    // ...
  } else {
    // 没有玩家角色时，仍然更新敌人位置（如果有积木控制）
    // 保证场景中的其他对象可以正常运行
  }
}, [currentPage]);
```

### 2. UI提示信息优化

#### 修改前
```tsx
{!playerComponentRef.current && (
  <span style={{ color: '#fbbf24' }}>⚠️ 未找到玩家角色</span>
)}
```
- 使用警告图标和黄色
- 给人感觉这是个错误

#### 修改后
```tsx
{!playerComponentRef.current && (
  <span style={{ color: '#94a3b8' }}>ℹ️ 此场景无玩家角色</span>
)}
```
- 使用信息图标和灰色
- 表示这是正常状态，只是没有玩家

### 3. 功能保留

#### ✅ 有玩家角色时
- WASD键盘控制
- 摄像机跟随
- 敌人追踪玩家
- 碰撞检测
- 所有游戏逻辑正常

#### ✅ 无玩家角色时
- 积木逻辑仍然执行
- 点击事件正常触发
- 场景切换正常工作
- 定时器正常运行
- UI组件可交互
- 按键提示自动隐藏

## 支持的场景类型

现在以下场景都可以正常预览：

### 1. 菜单场景
```
组件：
- 背景图片
- 开始游戏按钮
- 设置按钮
- 退出按钮

逻辑：
- 点击按钮 → 切换场景
- 无需玩家角色
```

### 2. 开场动画
```
组件：
- 动画序列
- 文字说明
- 跳过按钮

逻辑：
- 定时器 → 播放动画
- 点击跳过 → 进入游戏
```

### 3. 结束画面
```
组件：
- 得分显示
- 排行榜
- 重新开始按钮

逻辑：
- 显示游戏结果
- 点击重新开始 → 回到菜单
```

### 4. 过场动画
```
组件：
- 故事文本
- 背景图
- 继续按钮

逻辑：
- 展示剧情
- 点击继续 → 下一关
```

### 5. 教程场景
```
组件：
- 教学图片
- 说明文字
- 下一步按钮

逻辑：
- 引导玩家
- 无需实际操作
```

## 测试验证

### 测试用例1：开场菜单
```
场景：开场菜单
组件：背景 + 开始按钮
积木：event_click → state_gotoscene(scene: '第一关')
结果：✅ 点击按钮正常切换场景
```

### 测试用例2：游戏关卡
```
场景：第一关
组件：玩家 + 敌人 + 金币
积木：event_keypress → motion_move
结果：✅ WASD控制玩家，摄像机跟随
```

### 测试用例3：结束画面
```
场景：游戏结束
组件：得分显示 + 重新开始按钮
积木：event_click → state_gotoscene(scene: '菜单')
结果：✅ 显示得分，点击返回菜单
```

## 技术细节

### 关键代码变更

#### 位置1: 游戏循环入口 (第145-146行)
```diff
- if (!playerComponentRef.current || !currentPage) return;
+ if (!currentPage) return;
+
+ // 从引擎获取游戏对象
+ if (engineRef.current) {
+   gameObjectsRef.current = engineRef.current.getGameObjects();
+ }
+
+ // 如果有玩家角色，处理玩家相关逻辑
+ if (playerComponentRef.current) {
+   // 玩家逻辑...
+ } else {
+   // 无玩家场景逻辑...
+ }
```

#### 位置2: 敌人追踪逻辑 (第228-290行)
```diff
- // 无条件执行敌人追踪
+ // 仅当有玩家时执行追踪逻辑
+ currentPage.components.forEach(comp => {
+   if (comp.gameRole?.roleType === 'enemy') {
+     const chasePlayer = comp.gameRole.properties?.chasePlayer;
+     if (chasePlayer && playerComponentRef.current) {
+       // 追踪玩家...
+     }
+   }
+ });
```

#### 位置3: UI提示 (第565-571行)
```diff
  {!playerComponentRef.current && (
-   <span style={{ color: '#fbbf24' }}>⚠️ 未找到玩家角色</span>
+   <span style={{ color: '#94a3b8' }}>ℹ️ 此场景无玩家角色</span>
  )}
```

## 影响范围

### ✅ 向后兼容
- 有玩家的场景：功能完全不变
- 无玩家的场景：从无法运行变为正常运行

### ✅ 性能影响
- 无玩家场景：减少不必要的计算
- 有玩家场景：性能保持不变

### ✅ 用户体验
- 提示信息更友好
- 适用场景更广泛
- 不再有误导性警告

## 后续优化建议

1. **添加场景类型标识**
   - 在页面配置中添加 `sceneType: 'menu' | 'gameplay' | 'cutscene'`
   - 根据类型自动调整预览行为

2. **自定义摄像机**
   - 无玩家场景允许手动控制摄像机
   - 或固定摄像机位置

3. **更多场景模板**
   - 预设菜单场景模板
   - 预设结束画面模板
   - 预设教程场景模板

---

**修复完成！现在所有类型的场景都可以正常预览了。** 🎮
