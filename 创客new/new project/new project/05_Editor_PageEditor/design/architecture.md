# é¡µé¢ç¼–è¾‘å™¨ - æ¶æ„è®¾è®¡

## æ¦‚è¿°

é¡µé¢ç¼–è¾‘å™¨(PageEditor)æ˜¯å¾®ä¿¡å°ç¨‹åºå¯è§†åŒ–å¼€å‘å¹³å°çš„æ ¸å¿ƒç¼–è¾‘å™¨ç»„ä»¶,æä¾›æ‰€è§å³æ‰€å¾—çš„é¡µé¢è®¾è®¡èƒ½åŠ›ã€‚

**å‚è€ƒæ¥æº**: GDevelop SceneEditor + InstancesEditor

**æ ¸å¿ƒåŠŸèƒ½**:
- å¯è§†åŒ–ç”»å¸ƒ,æ”¯æŒç»„ä»¶æ‹–æ‹½ã€é€‰æ‹©ã€ç¼–è¾‘
- ç»„ä»¶å˜æ¢(ç§»åŠ¨ã€ç¼©æ”¾ã€æ—‹è½¬)
- ç½‘æ ¼å¯¹é½å’Œå¸é™„
- æ’¤é”€/é‡åš
- å¤šé€‰å’Œæ‰¹é‡æ“ä½œ
- ç»„ä»¶æ ‘ç®¡ç†

---

## æ•´ä½“æ¶æ„

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               React ç»„ä»¶å±‚ (UI)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SceneEditor  â”‚  â”‚ Toolbar  â”‚  â”‚ PropertyPanelâ”‚   â”‚
â”‚  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  â”‚ Canvas â”‚  â”‚  â”‚ LayerPanel   â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ ¸å¿ƒç®¡ç†å™¨å±‚ (Logic)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ CanvasRenderer  â”‚  â”‚ SelectionManager   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚TransformManager â”‚  â”‚ CommandManager     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ æ“ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ•°æ®æ¨¡å‹å±‚ (Data)                        â”‚
â”‚  Component, EditorState, CanvasState, etc.          â”‚
â”‚  (æ¥è‡ª 01_Core_ProjectStructure)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç±»è®¾è®¡

### 1. CanvasRenderer (ç”»å¸ƒæ¸²æŸ“å™¨)

**èŒè´£**:
- å°† Component æ ‘æ¸²æŸ“åˆ°ç”»å¸ƒ
- å¤„ç†å“åº”å¼å¸ƒå±€è®¡ç®—(rpx â†’ px)
- æ”¯æŒå¤šè®¾å¤‡é¢„è§ˆ(æ‰‹æœºã€å¹³æ¿)
- æ¸²æŸ“è¾…åŠ©å…ƒç´ (ç½‘æ ¼ã€æ ‡å°ºã€è¾…åŠ©çº¿)

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class CanvasRenderer {
  // æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
  renderComponents(
    components: Component[],
    context: RenderContext
  ): RenderedComponent[]

  // è®¡ç®—ç»„ä»¶åœ¨ç”»å¸ƒä¸Šçš„è¾¹ç•Œ
  calculateBounds(component: Component): Rectangle

  // å°† rpx æ ·å¼è½¬æ¢ä¸º px
  transformStyle(style: ComponentStyle, deviceWidth: number): CSSProperties

  // æ¸²æŸ“ç½‘æ ¼
  renderGrid(gridSize: number, canvasSize: Size): GridLines

  // æ¸²æŸ“æ ‡å°º
  renderRulers(canvasSize: Size, zoom: number): Rulers

  // æ¸²æŸ“å¯¹é½è¾…åŠ©çº¿
  renderAlignmentGuides(guides: AlignmentGuide[]): void
}
```

**è®¾è®¡è¦ç‚¹**:
- çº¯å‡½æ•°å¼è®¾è®¡,ä¾¿äºæµ‹è¯•
- æ”¯æŒåµŒå¥—ç»„ä»¶é€’å½’æ¸²æŸ“
- è®¾å¤‡å®½åº¦é€‚é…: æ‰‹æœº(375px), å¹³æ¿(750px)

---

### 2. SelectionManager (é€‰æ‹©ç®¡ç†å™¨)

**èŒè´£**:
- ç®¡ç†ç»„ä»¶é€‰æ‹©çŠ¶æ€
- æ”¯æŒå•é€‰ã€å¤šé€‰ã€æ¡†é€‰
- è®¡ç®—å¯¹é½è¾…åŠ©çº¿
- æä¾›é€‰æ‹©æŸ¥è¯¢æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class SelectionManager {
  private selectedIds: Set<string>

  // é€‰æ‹©å•ä¸ªç»„ä»¶
  selectComponent(id: string, options: SelectOptions): void

  // é€‰æ‹©å¤šä¸ªç»„ä»¶
  selectComponents(ids: string[]): void

  // æ¡†é€‰åŒºåŸŸå†…çš„ç»„ä»¶
  selectInRect(rect: Rectangle, components: Component[]): void

  // æ¸…ç©ºé€‰æ‹©
  clearSelection(): void

  // æŸ¥è¯¢é€‰æ‹©çŠ¶æ€
  isSelected(id: string): boolean
  getSelectedIds(): string[]
  getSelectedComponents(components: Component[]): Component[]

  // è®¡ç®—å¯¹é½è¾…åŠ©çº¿
  findAlignmentGuides(
    movingComponent: Component,
    allComponents: Component[],
    threshold: number
  ): AlignmentGuide[]
}
```

**å‚è€ƒ**: GDevelop InstancesSelection.js

**å¯¹é½ç®—æ³•**:
- æ£€æµ‹è¾¹ç¼˜å¯¹é½: left, right, top, bottom
- æ£€æµ‹ä¸­å¿ƒå¯¹é½: centerX, centerY
- é˜ˆå€¼: é»˜è®¤ 5px

---

### 3. TransformManager (å˜æ¢ç®¡ç†å™¨)

**èŒè´£**:
- å¤„ç†æ‹–æ‹½æ“ä½œ
- å¤„ç†ç¼©æ”¾æ“ä½œ
- å¤„ç†æ—‹è½¬æ“ä½œ(å¯é€‰)
- ç½‘æ ¼å¸é™„
- é”®ç›˜ç§»åŠ¨

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class TransformManager {
  // æ‹–æ‹½æ“ä½œ
  startDrag(componentId: string, startPos: Point): DragState
  updateDrag(dragState: DragState, currentPos: Point): Transform
  endDrag(dragState: DragState): void

  // ç¼©æ”¾æ“ä½œ
  startResize(
    componentId: string,
    handle: ResizeHandle,
    startPos: Point
  ): ResizeState
  updateResize(resizeState: ResizeState, currentPos: Point): Transform
  endResize(resizeState: ResizeState): void

  // æ—‹è½¬æ“ä½œ (å¯é€‰,æš‚ä¸å®ç°)
  // startRotate(...): RotateState

  // ç½‘æ ¼å¸é™„
  snapToGrid(value: number, gridSize: number): number
  snapBoundsToGrid(bounds: Rectangle, gridSize: number): Rectangle

  // é”®ç›˜ç§»åŠ¨
  moveByKeyboard(
    componentId: string,
    direction: Direction,
    distance: number
  ): Transform

  // çº¦æŸæ£€æŸ¥
  constrainToBounds(
    bounds: Rectangle,
    containerBounds: Rectangle
  ): Rectangle
}
```

**ç½‘æ ¼å¸é™„ç®—æ³•**:
```typescript
function snapToGrid(value: number, gridSize: number): number {
  return Math.round(value / gridSize) * gridSize;
}
```

**é”®ç›˜ç§»åŠ¨**:
- æ–¹å‘é”®: ç§»åŠ¨ 1px
- Shift + æ–¹å‘é”®: ç§»åŠ¨ 10px

---

### 4. CommandManager (å‘½ä»¤ç®¡ç†å™¨)

**èŒè´£**:
- å®ç°å‘½ä»¤æ¨¡å¼
- ç®¡ç†æ’¤é”€/é‡åšå †æ ˆ
- æ”¯æŒæ‰¹é‡å‘½ä»¤(å®å‘½ä»¤)

**æ ¸å¿ƒæ¥å£**:
```typescript
interface Command {
  execute(): void
  undo(): void
  description: string
}

class CommandManager {
  private undoStack: Command[] = []
  private redoStack: Command[] = []
  private maxStackSize: number = 50

  // æ‰§è¡Œå‘½ä»¤
  execute(command: Command): void {
    command.execute()
    this.undoStack.push(command)
    this.redoStack = [] // æ¸…ç©ºé‡åšæ ˆ
    this.trimStack()
  }

  // æ’¤é”€
  undo(): boolean {
    if (this.undoStack.length === 0) return false
    const command = this.undoStack.pop()!
    command.undo()
    this.redoStack.push(command)
    return true
  }

  // é‡åš
  redo(): boolean {
    if (this.redoStack.length === 0) return false
    const command = this.redoStack.pop()!
    command.execute()
    this.undoStack.push(command)
    return true
  }

  canUndo(): boolean
  canRedo(): boolean
  clear(): void
}
```

**å†…ç½®å‘½ä»¤ç±»å‹**:
```typescript
// ç§»åŠ¨å‘½ä»¤
class MoveCommand implements Command {
  constructor(
    private componentId: string,
    private oldPosition: Point,
    private newPosition: Point,
    private updateFn: UpdateFunction
  ) {}

  execute(): void {
    this.updateFn(this.componentId, { position: this.newPosition })
  }

  undo(): void {
    this.updateFn(this.componentId, { position: this.oldPosition })
  }
}

// ç±»ä¼¼: ResizeCommand, DeleteCommand, AddCommand, UpdatePropertiesCommand
```

---

## React ç»„ä»¶æ¶æ„

### ç»„ä»¶æ ‘ç»“æ„

```
<SceneEditor>
  â”œâ”€â”€ <Toolbar>
  â”‚   â”œâ”€â”€ æ’¤é”€/é‡åšæŒ‰é’®
  â”‚   â”œâ”€â”€ ç¼©æ”¾æ§åˆ¶
  â”‚   â”œâ”€â”€ è®¾å¤‡åˆ‡æ¢
  â”‚   â””â”€â”€ è¾…åŠ©çº¿å¼€å…³
  â”œâ”€â”€ <CanvasContainer>
  â”‚   â”œâ”€â”€ <Rulers> (å¯é€‰)
  â”‚   â””â”€â”€ <Canvas>
  â”‚       â”œâ”€â”€ <Grid> (å¯é€‰)
  â”‚       â”œâ”€â”€ <AlignmentGuides>
  â”‚       â”œâ”€â”€ <ComponentRenderer> (é€’å½’æ¸²æŸ“)
  â”‚       â””â”€â”€ <SelectionBox>
  â”œâ”€â”€ <PropertyPanel>
  â”‚   â””â”€â”€ (é›†æˆ 08_Editor_PropertyEditor)
  â””â”€â”€ <LayerPanel>
      â””â”€â”€ <ComponentTree>
```

---

### SceneEditor (ä¸»ç¼–è¾‘å™¨)

**èŒè´£**: æ•´åˆæ‰€æœ‰å­ç»„ä»¶,ç®¡ç†å…¨å±€çŠ¶æ€

**çŠ¶æ€ç®¡ç†**:
```typescript
interface SceneEditorState {
  // ç”»å¸ƒçŠ¶æ€
  canvas: {
    zoom: number           // ç¼©æ”¾æ¯”ä¾‹ (0.1 ~ 3.0)
    offset: Point          // ç”»å¸ƒåç§»
    deviceType: DeviceType // 'mobile' | 'tablet'
    showGrid: boolean
    gridSize: number       // é»˜è®¤ 8px
    showRulers: boolean
  }

  // é€‰æ‹©çŠ¶æ€
  selection: {
    selectedIds: string[]
    isMultiSelect: boolean
    selectionBox?: Rectangle
  }

  // å˜æ¢çŠ¶æ€
  transform: {
    isDragging: boolean
    isResizing: boolean
    currentOperation?: Operation
  }

  // å†å²çŠ¶æ€
  history: {
    canUndo: boolean
    canRedo: boolean
  }
}
```

**Props**:
```typescript
interface SceneEditorProps {
  // æ•°æ®
  page: Page
  onPageUpdate: (page: Page) => void

  // é€‰æ‹©å›è°ƒ
  selectedComponentId?: string
  onComponentSelect: (componentId: string | null) => void

  // ç»„ä»¶æ“ä½œå›è°ƒ
  onComponentAdd: (component: Component, parentId?: string) => void
  onComponentUpdate: (componentId: string, updates: Partial<Component>) => void
  onComponentDelete: (componentId: string) => void
  onComponentMove: (componentId: string, newParentId: string, index: number) => void

  // é…ç½®
  config?: EditorConfig
}
```

**å¿«æ·é”®æ”¯æŒ**:
```
Ctrl/Cmd + Z    : æ’¤é”€
Ctrl/Cmd + Y    : é‡åš
Delete/Backspace: åˆ é™¤é€‰ä¸­ç»„ä»¶
Ctrl/Cmd + C    : å¤åˆ¶
Ctrl/Cmd + V    : ç²˜è´´
Ctrl/Cmd + D    : å¤åˆ¶å¹¶ç²˜è´´
æ–¹å‘é”®           : ç§»åŠ¨ 1px
Shift + æ–¹å‘é”®   : ç§»åŠ¨ 10px
Ctrl/Cmd + A    : å…¨é€‰
Escape          : å–æ¶ˆé€‰æ‹©
```

---

### Canvas (ç”»å¸ƒç»„ä»¶)

**èŒè´£**: æ¸²æŸ“ç”»å¸ƒå’Œç»„ä»¶,å¤„ç†é¼ æ ‡äº¤äº’

**Props**:
```typescript
interface CanvasProps {
  components: Component[]
  canvasState: CanvasState
  selectionState: SelectionState

  // äº‹ä»¶å›è°ƒ
  onComponentClick: (id: string, event: MouseEvent) => void
  onCanvasClick: (event: MouseEvent) => void
  onDragStart: (id: string, position: Point) => void
  onDragMove: (position: Point) => void
  onDragEnd: () => void
  onResizeStart: (id: string, handle: ResizeHandle, position: Point) => void
  onResizeMove: (position: Point) => void
  onResizeEnd: () => void
}
```

**é¼ æ ‡äº¤äº’å¤„ç†**:
```typescript
// æ‹–æ‹½æµç¨‹
onMouseDown -> åˆ¤æ–­ç‚¹å‡»ä½ç½® ->
  - ç‚¹å‡»ç»„ä»¶ -> startDrag
  - ç‚¹å‡»ç”»å¸ƒ -> å¼€å§‹æ¡†é€‰
  - ç‚¹å‡»ç¼©æ”¾æ‰‹æŸ„ -> startResize

onMouseMove ->
  - æ‹–æ‹½ä¸­ -> updateDrag
  - ç¼©æ”¾ä¸­ -> updateResize
  - æ¡†é€‰ä¸­ -> æ›´æ–°é€‰æ‹©æ¡†

onMouseUp ->
  - endDrag / endResize / å®Œæˆæ¡†é€‰
```

**æ€§èƒ½ä¼˜åŒ–**:
- ä½¿ç”¨ `React.memo` é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- ä½¿ç”¨ `requestAnimationFrame` é™åˆ¶æ‹–æ‹½æ›´æ–°é¢‘ç‡
- å¤§é‡ç»„ä»¶æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨

---

### Toolbar (å·¥å…·æ )

**åŠŸèƒ½**:
- æ’¤é”€/é‡åšæŒ‰é’®
- ç¼©æ”¾æ§åˆ¶ (10% ~ 300%)
- è®¾å¤‡ç±»å‹åˆ‡æ¢ (æ‰‹æœº / å¹³æ¿)
- ç½‘æ ¼å¼€å…³
- æ ‡å°ºå¼€å…³

**UI å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [æ’¤é”€] [é‡åš] | [50%] [-] [+] | [æ‰‹æœº â–¼] â”‚
â”‚               | [ç½‘æ ¼] [æ ‡å°º]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### PropertyPanel (å±æ€§é¢æ¿)

**èŒè´£**: æ˜¾ç¤ºå’Œç¼–è¾‘é€‰ä¸­ç»„ä»¶çš„å±æ€§

**é›†æˆæ–¹å¼**:
- ä½¿ç”¨ `08_Editor_PropertyEditor` æ¨¡å—
- ä¼ å…¥é€‰ä¸­çš„ Component
- å“åº”å±æ€§å˜æ›´å›è°ƒ

**Props**:
```typescript
interface PropertyPanelProps {
  selectedComponent: Component | null
  onPropertyChange: (property: string, value: any) => void
  onStyleChange: (styleKey: string, value: string) => void
}
```

---

### LayerPanel (å›¾å±‚é¢æ¿)

**èŒè´£**: æ˜¾ç¤ºç»„ä»¶æ ‘,æ”¯æŒæ‹–æ‹½æ’åº

**åŠŸèƒ½**:
- æ ‘çŠ¶æ˜¾ç¤ºç»„ä»¶å±‚çº§
- å±•å¼€/æŠ˜å 
- æ˜¾ç¤º/éšè—ç»„ä»¶
- é”å®š/è§£é”ç»„ä»¶
- æ‹–æ‹½æ’åº

**UI ç¤ºä¾‹**:
```
å›¾å±‚
â”œâ”€ ğŸ”’ page (é”å®š)
â”‚  â”œâ”€ ğŸ‘ header (å¯è§)
â”‚  â”‚  â”œâ”€ logo
â”‚  â”‚  â””â”€ nav
â”‚  â”œâ”€ ğŸ‘â€ğŸ—¨ content (éšè—)
â”‚  â””â”€ footer
```

---

## æ•°æ®æµè®¾è®¡

### å•å‘æ•°æ®æµ

```
User Action (é¼ æ ‡/é”®ç›˜)
  â†“
Event Handler (Canvas/Toolbar)
  â†“
Manager å¤„ç† (TransformManager/SelectionManager)
  â†“
Command æ‰§è¡Œ (CommandManager)
  â†“
State æ›´æ–° (SceneEditorState)
  â†“
Props ä¼ é€’ (React)
  â†“
UI é‡æ¸²æŸ“ (Canvas/LayerPanel)
```

### çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

**ä½¿ç”¨ React Context + useReducer**:

```typescript
// EditorContext.tsx
const EditorContext = createContext<EditorContextValue>(null!)

interface EditorContextValue {
  state: SceneEditorState
  dispatch: Dispatch<EditorAction>

  // Managers
  canvasRenderer: CanvasRenderer
  selectionManager: SelectionManager
  transformManager: TransformManager
  commandManager: CommandManager
}

// Actions
type EditorAction =
  | { type: 'SELECT_COMPONENT'; payload: { id: string; multiSelect: boolean } }
  | { type: 'CLEAR_SELECTION' }
  | { type: 'UPDATE_CANVAS'; payload: Partial<CanvasState> }
  | { type: 'START_DRAG'; payload: { id: string; position: Point } }
  | { type: 'UPDATE_DRAG'; payload: { position: Point } }
  | { type: 'END_DRAG' }
  | { type: 'UNDO' }
  | { type: 'REDO' }
  // ...
```

---

## è®¾å¤‡é€‚é…

### å¾®ä¿¡å°ç¨‹åºå°ºå¯¸è§„èŒƒ

**rpx (responsive pixel)**:
- è§„å®šå±å¹•å®½åº¦ä¸º 750rpx
- iPhone 6 å±å¹•å®½åº¦ 375px â†’ 750rpx
- 1rpx = 0.5px (iPhone 6)

### ç¼–è¾‘å™¨é€‚é…æ–¹æ¡ˆ

**æ‰‹æœºæ¨¡å¼** (é»˜è®¤):
- ç”»å¸ƒå®½åº¦: 375px (å¯¹åº” 750rpx)
- æ¯”ä¾‹: 1rpx = 0.5px

**å¹³æ¿æ¨¡å¼**:
- ç”»å¸ƒå®½åº¦: 750px (å¯¹åº” 750rpx)
- æ¯”ä¾‹: 1rpx = 1px

**è½¬æ¢å‡½æ•°**:
```typescript
function rpxToPixel(rpx: number, deviceType: DeviceType): number {
  const baseWidth = deviceType === 'mobile' ? 375 : 750
  return (rpx / 750) * baseWidth
}

function pixelToRpx(px: number, deviceType: DeviceType): number {
  const baseWidth = deviceType === 'mobile' ? 375 : 750
  return (px / baseWidth) * 750
}
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¸²æŸ“ä¼˜åŒ–
- ä½¿ç”¨ `React.memo` åŒ…è£¹ç»„ä»¶
- ä½¿ç”¨ `useMemo` / `useCallback` ç¼“å­˜è®¡ç®—å’Œå‡½æ•°
- é¿å…å†…è”æ ·å¼å¯¹è±¡,ä½¿ç”¨ CSS Modules

### 2. æ‹–æ‹½ä¼˜åŒ–
- ä½¿ç”¨ `requestAnimationFrame` èŠ‚æµ
- ä»…æ›´æ–°å¿…è¦çš„çŠ¶æ€
- æ‹–æ‹½æ—¶ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»

### 3. å¤§æ•°æ®é‡ä¼˜åŒ–
- ç»„ä»¶è¶…è¿‡ 100 ä¸ªæ—¶å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
- å›¾å±‚é¢æ¿ä½¿ç”¨ `react-window`
- æ‡’åŠ è½½ç»„ä»¶é¢„è§ˆå›¾

### 4. å†…å­˜ä¼˜åŒ–
- åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
- é™åˆ¶æ’¤é”€æ ˆå¤§å°(é»˜è®¤ 50)
- ä½¿ç”¨ WeakMap ç¼“å­˜è®¡ç®—ç»“æœ

---

## æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶åŒ–æ¶æ„

**é¢„ç•™æ‰©å±•ç‚¹**:
```typescript
interface EditorPlugin {
  name: string
  onInit: (editor: SceneEditor) => void
  onDestroy: () => void

  // æ‰©å±•å·¥å…·æ 
  toolbarItems?: ToolbarItem[]

  // æ‰©å±•å³é”®èœå•
  contextMenuItems?: MenuItem[]

  // æ‰©å±•å¿«æ·é”®
  shortcuts?: Shortcut[]

  // è‡ªå®šä¹‰å‘½ä»¤
  commands?: Command[]
}
```

**ç¤ºä¾‹æ’ä»¶**:
- å¯¹é½å·¥å…·æ’ä»¶
- ç»„ä»¶æ¨¡æ¿æ’ä»¶
- AI å¸ƒå±€å»ºè®®æ’ä»¶

---

## å¯è®¿é—®æ€§ (Accessibility)

### é”®ç›˜å¯¼èˆª
- Tab: åˆ‡æ¢é€‰æ‹©
- æ–¹å‘é”®: ç§»åŠ¨ç»„ä»¶
- Enter: ç¼–è¾‘ç»„ä»¶

### å±å¹•é˜…è¯»å™¨
- æ‰€æœ‰æŒ‰é’®æ·»åŠ  `aria-label`
- ç»„ä»¶æ ‘ä½¿ç”¨ `role="tree"` å’Œ `role="treeitem"`
- ç”»å¸ƒæ·»åŠ  `aria-label="ç”»å¸ƒåŒºåŸŸ"`

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- CanvasRenderer: æ¸²æŸ“é€»è¾‘ã€å¸ƒå±€è®¡ç®—
- SelectionManager: é€‰æ‹©é€»è¾‘ã€å¤šé€‰ã€æ¡†é€‰
- TransformManager: æ‹–æ‹½ã€ç¼©æ”¾ã€å¸é™„
- CommandManager: æ’¤é”€/é‡åšã€å †æ ˆç®¡ç†

### é›†æˆæµ‹è¯•
- æ‹–æ‹½ â†’ æ’¤é”€ â†’ é‡åš æµç¨‹
- å¤šé€‰ â†’ æ‰¹é‡ç§»åŠ¨ æµç¨‹
- ç»„ä»¶æ ‘ â†’ æ‹–æ‹½æ’åº æµç¨‹

### E2E æµ‹è¯• (å¯é€‰)
- å®Œæ•´çš„ç”¨æˆ·æ“ä½œæµç¨‹
- ä½¿ç”¨ Playwright

---

## æ€»ç»“

é¡µé¢ç¼–è¾‘å™¨é‡‡ç”¨**åˆ†å±‚æ¶æ„**:
- **UI å±‚** (React ç»„ä»¶): è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’
- **é€»è¾‘å±‚** (Managers): è´Ÿè´£ä¸šåŠ¡é€»è¾‘
- **æ•°æ®å±‚** (Models): è´Ÿè´£æ•°æ®ç»“æ„

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**:
1. **å•ä¸€èŒè´£**: æ¯ä¸ªç±»åªåšä¸€ä»¶äº‹
2. **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
3. **å‘½ä»¤æ¨¡å¼**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯å‘½ä»¤,æ”¯æŒæ’¤é”€
4. **çº¯å‡½æ•°**: æ¸²æŸ“å’Œè®¡ç®—é€»è¾‘å°½é‡çº¯å‡½æ•°åŒ–

**å‚è€ƒ GDevelop**:
- InstancesSelection â†’ SelectionManager
- å‘½ä»¤æ¨¡å¼ â†’ CommandManager
- React ç»„ä»¶ç»“æ„ â†’ SceneEditor

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ `dataflow.md` äº†è§£è¯¦ç»†çš„æ•°æ®æµè®¾è®¡ã€‚
