# 预览模拟器 - 架构设计

## 概述

预览模拟器模块提供了实时预览、调试和性能监控功能,让开发者能够在浏览器中模拟微信小程序环境,实时查看编辑结果。

## 核心组件

### 1. Simulator - 模拟器核心

**职责:**
- 管理模拟器生命周期
- 协调各子模块工作
- 提供统一的API接口

**核心功能:**
- 启动/停止模拟器
- 加载小程序代码
- 管理设备配置
- 处理预览请求

### 2. PreviewServer - 预览服务器

**职责:**
- 提供HTTP服务
- 托管预览页面
- 处理静态资源

**核心功能:**
- 启动本地HTTP服务器
- 提供WebSocket连接
- 路由管理
- 资源缓存

**技术选型:**
- HTTP服务器: Express或类似框架
- WebSocket: ws或socket.io
- 端口: 默认8080,可配置

### 3. HotReload - 热重载

**职责:**
- 监听文件变化
- 触发代码重新生成
- 推送更新到客户端

**核心功能:**
- 文件监听(chokidar)
- 增量更新
- 变更检测
- 客户端通知

**工作流程:**
```
文件变化 -> 检测变更 -> 重新生成代码 -> 通过WebSocket推送 -> 客户端重新加载
```

### 4. DeviceSimulator - 设备模拟

**职责:**
- 模拟不同设备特性
- 提供设备预设配置
- 处理设备相关API

**核心功能:**
- 屏幕尺寸模拟
- 设备像素比(DPR)
- 触摸事件转换
- 网络状态模拟
- 定位模拟

**预设设备:**
- iPhone 13 Pro (390×844, 3x)
- iPhone SE (375×667, 2x)
- iPad Air (820×1180, 2x)
- 小米手机 (393×851, 2.75x)
- 华为手机 (360×780, 3x)
- 自定义尺寸

### 5. DebuggerBridge - 调试器桥接

**职责:**
- 连接微信开发者工具调试器
- 转发调试信息
- 提供调试API

**核心功能:**
- Console输出捕获
- 网络请求拦截
- 错误捕获和上报
- 断点调试支持(可选)

### 6. PerformanceMonitor - 性能监控

**职责:**
- 收集性能数据
- 分析性能瓶颈
- 提供性能报告

**监控指标:**
- 页面加载时间
- setData调用频率和耗时
- 渲染帧率(FPS)
- 内存使用
- 网络请求统计
- 组件渲染时间

### 7. MockEnvironment - Mock环境

**职责:**
- 模拟微信API
- 提供测试数据
- 隔离外部依赖

**Mock API范围:**
- 基础API (wx.request, wx.showToast等)
- 界面API (wx.showModal, wx.showLoading等)
- 路由API (wx.navigateTo, wx.redirectTo等)
- 存储API (wx.setStorage, wx.getStorage等)
- 设备API (wx.getSystemInfo, wx.getLocation等)
- 文件API (模拟文件系统)
- 云开发API (可选,基础Mock)

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        Simulator                             │
│  (模拟器核心 - 协调所有模块)                                   │
└────────┬──────────────────────────────────────────┬─────────┘
         │                                          │
    ┌────▼────────┐                         ┌──────▼──────┐
    │ PreviewServer│                        │ HotReload    │
    │ (预览服务器)  │◄──WebSocket────────────│ (热重载)      │
    └────┬────────┘                         └──────▲──────┘
         │                                          │
    ┌────▼─────────────────────────────────────────┴──────┐
    │            浏览器预览页面                              │
    ├──────────────────────────────────────────────────────┤
    │  ┌──────────────┐  ┌────────────────┐               │
    │  │DeviceSimulator│  │MockEnvironment │               │
    │  │(设备模拟)     │  │(Mock API)      │               │
    │  └──────────────┘  └────────────────┘               │
    │  ┌───────────────┐  ┌─────────────────┐             │
    │  │DebuggerBridge │  │PerformanceMonitor│             │
    │  │(调试器桥接)    │  │(性能监控)        │             │
    │  └───────────────┘  └─────────────────┘             │
    └──────────────────────────────────────────────────────┘
```

## 数据流

### 1. 启动流程

```
1. 创建Simulator实例
2. 初始化PreviewServer
3. 启动HTTP服务器和WebSocket
4. 初始化HotReload文件监听
5. 加载初始代码
6. 打开浏览器预览页面
```

### 2. 热重载流程

```
1. 文件变化 (编辑器保存)
2. HotReload检测到变化
3. 识别变更类型 (WXML/WXSS/JS)
4. 调用对应的代码生成器
5. 生成新代码
6. 通过WebSocket推送更新
7. 浏览器接收更新
8. 根据类型决定重载方式:
   - WXSS: 热替换样式
   - WXML: 重新渲染页面
   - JS: 重新加载页面
```

### 3. 调试流程

```
1. 浏览器端发生事件 (console.log, 错误等)
2. DebuggerBridge捕获事件
3. 格式化调试信息
4. 通过WebSocket发送到服务器
5. 服务器转发到调试面板
6. 开发者查看调试信息
```

### 4. 性能监控流程

```
1. PerformanceMonitor定时采集性能数据
2. 记录关键指标 (setData, 渲染时间等)
3. 分析性能瓶颈
4. 生成性能报告
5. 展示在调试面板
```

## 技术选型

### 服务器端
- **HTTP服务器**: Express
- **WebSocket**: ws
- **文件监听**: chokidar
- **代码生成**: 复用已有的代码生成器

### 客户端
- **框架**: 纯JavaScript (兼容性)
- **通信**: WebSocket API
- **渲染**: 基于WXML/WXSS转换

### 依赖项
```json
{
  "express": "^4.18.0",
  "ws": "^8.13.0",
  "chokidar": "^3.5.3",
  "open": "^8.4.0"
}
```

## 安全考虑

1. **端口冲突**: 自动检测端口占用,尝试下一个端口
2. **跨域问题**: 配置CORS策略
3. **文件访问**: 限制只能访问项目目录内文件
4. **WebSocket认证**: 简单的token认证机制
5. **资源限制**: 限制单次传输大小

## 扩展性设计

### 插件系统
支持通过插件扩展功能:
- 自定义设备预设
- 自定义Mock API
- 自定义性能指标
- 自定义调试工具

### 配置系统
支持通过配置文件自定义:
- 服务器端口
- 热重载延迟
- 性能监控采样率
- Mock数据

## 性能优化

1. **增量更新**: 只重新生成变更的部分
2. **缓存策略**: 缓存未变更的资源
3. **懒加载**: 按需加载Mock API
4. **压缩传输**: WebSocket消息压缩
5. **批量更新**: 合并短时间内的多次变更

## 错误处理

1. **服务器启动失败**: 提供清晰的错误信息和解决建议
2. **代码生成失败**: 显示生成错误,不影响服务器运行
3. **WebSocket断连**: 自动重连机制
4. **文件监听失败**: 降级到手动刷新模式
5. **Mock API错误**: 提供友好的错误提示

## 测试策略

1. **单元测试**: 测试各模块核心功能
2. **集成测试**: 测试模块间协作
3. **端到端测试**: 测试完整的预览流程
4. **性能测试**: 验证热重载速度和资源占用

## 未来规划

1. **多设备同步预览**: 同时在多个设备上预览
2. **时间旅行调试**: 录制和回放用户操作
3. **性能建议**: AI驱动的性能优化建议
4. **真机预览**: 生成二维码在真机上预览
5. **协作调试**: 多人同时调试同一个项目
