# åœºæ™¯åˆ‡æ¢åŠŸèƒ½å®Œæ•´æŒ‡å—

**æ›´æ–°æ—¶é—´**: 2026-01-27 å‡Œæ™¨2:37
**åŠŸèƒ½**: ç‚¹å‡»æŒ‰é’®åˆ‡æ¢åœºæ™¯

## ä¿®å¤å†…å®¹

### âœ… æ–°å¢åœºæ™¯åˆ‡æ¢ç›‘å¬

**é—®é¢˜**:
- `state_gotoscene` ç§¯æœ¨åªå‘å‡ºäº‹ä»¶ï¼Œæ²¡æœ‰å®é™…åˆ‡æ¢é¡µé¢
- GamePreviewæ²¡æœ‰ç›‘å¬åœºæ™¯åˆ‡æ¢äº‹ä»¶

**è§£å†³æ–¹æ¡ˆ**:
åœ¨GamePreviewä¸­ç›‘å¬ `SCENE_CHANGE` äº‹ä»¶å¹¶è°ƒç”¨ `setCurrentPage` åˆ‡æ¢åœºæ™¯ã€‚

```typescript
// ç›‘å¬åœºæ™¯åˆ‡æ¢äº‹ä»¶
engineRef.current.getEventSystem().on(GameEvents.SCENE_CHANGE, (data: any) => {
  console.log('[GamePreview] åœºæ™¯åˆ‡æ¢äº‹ä»¶è§¦å‘:', data);
  const { sceneId } = data;

  // åˆ‡æ¢åˆ°æŒ‡å®šåœºæ™¯
  if (sceneId) {
    console.log('[GamePreview] æ­£åœ¨åˆ‡æ¢åˆ°åœºæ™¯:', sceneId);
    setCurrentPage(sceneId);
  }
});
```

## ä½¿ç”¨æŒ‡å—

### æ­¥éª¤1: åˆ›å»ºå¤šä¸ªåœºæ™¯

1. **åˆ›å»ºå¼€åœºåœºæ™¯**
   - å·¦ä¾§é¢æ¿ â†’ é¡µé¢
   - ç‚¹å‡»"+"åˆ›å»ºæ–°é¡µé¢
   - å‘½åä¸º"å¼€åœºèœå•"

2. **åˆ›å»ºæ¸¸æˆåœºæ™¯**
   - å†æ¬¡ç‚¹å‡»"+"
   - å‘½åä¸º"ç¬¬ä¸€å…³"

### æ­¥éª¤2: è®¾ç½®æŒ‰é’®ç§¯æœ¨

1. **é€‰ä¸­æŒ‰é’®ç»„ä»¶**
2. **å³ä¾§é¢æ¿ â†’ é€»è¾‘ç§¯æœ¨**
3. **æ·»åŠ ç§¯æœ¨**:
   ```
   äº‹ä»¶: å½“ç‚¹å‡»æ—¶ (event_click)
   â†“
   åŠ¨ä½œ: è·³è½¬åœºæ™¯ (state_gotoscene)
   å‚æ•°: scene = "ç¬¬ä¸€å…³"  â† å¡«å†™ç›®æ ‡åœºæ™¯çš„ID
   ```

### æ­¥éª¤3: æµ‹è¯•

1. **åˆ·æ–°é¡µé¢**: `Ctrl + Shift + R`
2. **æ‰“å¼€F12å¼€å‘è€…å·¥å…·** â†’ Consoleæ ‡ç­¾
3. **è¿›å…¥é¢„è§ˆæ¨¡å¼**
4. **ç‚¹å‡»æŒ‰é’®**

## é¢„æœŸæ•ˆæœ

### Console æ—¥å¿—
```
[GamePreview] ç»„ä»¶è¢«ç‚¹å‡»: å¼€å§‹æŒ‰é’® comp-xxx
[GameEngine] handleClick called for: comp-xxx
[GameEngine] Found clicked object: å¼€å§‹æŒ‰é’® - scripts: 1
[GameEngine] Executing onClick script with 1 blocks
[BlockExecutor] Executing block: state_gotoscene
[GamePreview] åœºæ™¯åˆ‡æ¢äº‹ä»¶è§¦å‘: { sceneId: "page-xxx" }
[GamePreview] æ­£åœ¨åˆ‡æ¢åˆ°åœºæ™¯: page-xxx
```

### è§†è§‰æ•ˆæœ
- ç‚¹å‡»æŒ‰é’®å
- ç”»é¢åˆ‡æ¢åˆ°æ–°åœºæ™¯
- æ–°åœºæ™¯çš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥

## é‡è¦æ³¨æ„äº‹é¡¹

### 1. åœºæ™¯ID vs åœºæ™¯åç§°

**é”™è¯¯ç”¨æ³•** âŒ:
```
ç§¯æœ¨å‚æ•°: scene = "ç¬¬ä¸€å…³"  â† è¿™æ˜¯åç§°ï¼Œä¸æ˜¯IDï¼
```

**æ­£ç¡®ç”¨æ³•** âœ…:
```
ç§¯æœ¨å‚æ•°: scene = "page-123abc"  â† è¿™æ˜¯é¡µé¢ID
```

### å¦‚ä½•è·å–åœºæ™¯IDï¼Ÿ

**æ–¹å¼1: ä»Consoleæ—¥å¿—**
```
æ‰“å¼€F12 â†’ Console
åˆ‡æ¢åœºæ™¯æ—¶æŸ¥çœ‹æ—¥å¿—ä¸­çš„ID
```

**æ–¹å¼2: æ£€æŸ¥ç§¯æœ¨å‚æ•°**
AIç”Ÿæˆçš„ç§¯æœ¨åº”è¯¥å·²ç»åŒ…å«æ­£ç¡®çš„ID

**æ–¹å¼3: ä½¿ç”¨åœºæ™¯åç§°ï¼ˆéœ€è¦æ”¹è¿›ï¼‰**
ç›®å‰ç³»ç»Ÿä½¿ç”¨IDï¼Œæœªæ¥å¯ä»¥æ”¹ä¸ºæ”¯æŒåç§°æŸ¥æ‰¾

### 2. AIç”Ÿæˆçš„ç§¯æœ¨æ£€æŸ¥

ä½¿ç”¨AIç”Ÿæˆç§¯æœ¨åï¼Œéœ€è¦ç¡®è®¤ï¼š

âœ… **äº‹ä»¶ç±»å‹**:
```
åº”è¯¥æ˜¯: event_click (å½“ç‚¹å‡»æ—¶)
ä¸æ˜¯: event_keypress, event_sceneinit ç­‰
```

âœ… **ç§¯æœ¨ç±»å‹**:
```
åº”è¯¥æ˜¯: state_gotoscene (è·³è½¬åœºæ™¯)
ä¸æ˜¯: state_setscore, motion_move ç­‰
```

âœ… **å‚æ•°é…ç½®**:
```typescript
{
  type: "state_gotoscene",
  values: {
    scene: "page-xxx"  // æˆ– sceneId: "page-xxx"
  }
}
```

### 3. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜1: ç‚¹å‡»æ²¡ååº”

**æ£€æŸ¥æ¸…å•**:
```
1. F12 â†’ Console æŸ¥çœ‹æ˜¯å¦æœ‰æ—¥å¿—
2. ç¡®è®¤ç§¯æœ¨çš„triggeræ˜¯ 'onClick'
3. ç¡®è®¤æŒ‰é’®ç»„ä»¶å·²ç»‘å®šç§¯æœ¨
4. æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯
```

**å¦‚æœçœ‹åˆ°æ—¥å¿—ä½†æ²¡åˆ‡æ¢**:
```
[GamePreview] ç»„ä»¶è¢«ç‚¹å‡»: xxx âœ…
[GameEngine] handleClick called âœ…
[GameEngine] Found clicked object âœ…
[GameEngine] Executing onClick script âœ…
[BlockExecutor] Executing block: state_gotoscene âœ…
[GamePreview] åœºæ™¯åˆ‡æ¢äº‹ä»¶è§¦å‘ âŒ â† è¿™è¡Œæ²¡å‡ºç°

â†’ å¯èƒ½æ˜¯ç§¯æœ¨å‚æ•°é”™è¯¯
â†’ æ£€æŸ¥sceneå‚æ•°æ˜¯å¦æ­£ç¡®
```

#### é—®é¢˜2: åˆ‡æ¢åˆ°é”™è¯¯çš„åœºæ™¯

**åŸå› **: sceneId é”™è¯¯

**è§£å†³**:
```typescript
// æ–¹æ³•1: ä½¿ç”¨åœºæ™¯åç§°æŸ¥æ‰¾ID
const pages = usePageStore.getState().pages;
const targetPage = pages.find(p => p.name === "ç¬¬ä¸€å…³");
console.log('åœºæ™¯ID:', targetPage?.id);

// æ–¹æ³•2: åˆ—å‡ºæ‰€æœ‰åœºæ™¯
console.table(pages.map(p => ({
  åç§°: p.name,
  ID: p.id,
  è·¯å¾„: p.path
})));
```

#### é—®é¢˜3: åœºæ™¯åˆ‡æ¢åç«‹å³è¿”å›

**åŸå› **: å¯èƒ½æœ‰å¤šä¸ªç§¯æœ¨å†²çª

**æ£€æŸ¥**:
- æ–°åœºæ™¯æ˜¯å¦ä¹Ÿæœ‰è‡ªåŠ¨è·³è½¬çš„ç§¯æœ¨ï¼Ÿ
- event_sceneinit ç§¯æœ¨æ˜¯å¦ä¼šè§¦å‘è¿”å›ï¼Ÿ

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹1: ç®€å•èœå•

```
åœºæ™¯: å¼€åœºèœå•
ç»„ä»¶:
  - èƒŒæ™¯å›¾ç‰‡
  - æ ‡é¢˜æ–‡å­—: "æˆ‘çš„æ¸¸æˆ"
  - å¼€å§‹æŒ‰é’®

æŒ‰é’®ç§¯æœ¨:
  event_click
  â†’ state_gotoscene(scene: "ç¬¬ä¸€å…³")
```

### ç¤ºä¾‹2: å¤šå…³å¡åˆ‡æ¢

```
åœºæ™¯: ç¬¬ä¸€å…³
ç»„ä»¶:
  - ç©å®¶è§’è‰²
  - æ•Œäºº
  - å‡ºå£æŒ‰é’®

å‡ºå£æŒ‰é’®ç§¯æœ¨:
  event_click
  â†’ state_gotoscene(scene: "ç¬¬äºŒå…³")
```

### ç¤ºä¾‹3: æ¡ä»¶è·³è½¬

```
åœºæ™¯: æ¸¸æˆåœºæ™¯
ç»„ä»¶:
  - åˆ†æ•°æ˜¾ç¤º
  - ç»“æŸæŒ‰é’®

ç»“æŸæŒ‰é’®ç§¯æœ¨:
  event_click
  â†’ logic_if (score >= 100)
     â†’ state_gotoscene(scene: "èƒœåˆ©ç”»é¢")
  â†’ logic_ifelse
     â†’ state_gotoscene(scene: "å¤±è´¥ç”»é¢")
```

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨Consoleä¸­è¿è¡Œï¼š
```javascript
// æŸ¥çœ‹å½“å‰åœºæ™¯ä¿¡æ¯
console.log('å½“å‰åœºæ™¯:', usePageStore.getState().getCurrentPage());

// æŸ¥çœ‹æ‰€æœ‰åœºæ™¯
console.log('æ‰€æœ‰åœºæ™¯:', useProjectStore.getState().currentProject.pages);
```

### 2. æ‰‹åŠ¨è§¦å‘åœºæ™¯åˆ‡æ¢

åœ¨Consoleä¸­æµ‹è¯•ï¼š
```javascript
// ç›´æ¥åˆ‡æ¢åœºæ™¯
usePageStore.getState().setCurrentPage('page-xxx');
```

### 3. æ£€æŸ¥ç§¯æœ¨é…ç½®

åœ¨ç¼–è¾‘å™¨ä¸­ï¼š
```
1. é€‰ä¸­ç»„ä»¶
2. å³ä¾§é¢æ¿ â†’ é€»è¾‘ç§¯æœ¨
3. ç‚¹å‡»ç§¯æœ¨æŸ¥çœ‹è¯¦æƒ…
4. ç¡®è®¤å‚æ•°é…ç½®
```

## æŠ€æœ¯ç»†èŠ‚

### äº‹ä»¶æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
  â†“
GamePreview.handleClick
  â†“
GameEngine.handleClick
  â†“
æ‰¾åˆ°GameObject
  â†“
æ‰§è¡ŒonClickè„šæœ¬
  â†“
BlockExecutor.executeBlocks
  â†“
state_gotoscene ç§¯æœ¨æ‰§è¡Œ
  â†“
GameStateManager.setCurrentScene
  â†“
EventSystem.emit(SCENE_CHANGE)
  â†“
GamePreviewç›‘å¬åˆ°äº‹ä»¶
  â†“
PageStore.setCurrentPage
  â†“
åœºæ™¯åˆ‡æ¢å®Œæˆ
```

### å…³é”®ä»£ç ä½ç½®

1. **ç§¯æœ¨æ‰§è¡Œå™¨**
   - `src/engine/BlockExecutor.ts:1409`
   - å¤„ç† `state_gotoscene` ç§¯æœ¨

2. **äº‹ä»¶ç›‘å¬**
   - `src/components/preview/GamePreview.tsx:55-65`
   - ç›‘å¬åœºæ™¯åˆ‡æ¢äº‹ä»¶

3. **åœºæ™¯ç®¡ç†**
   - `src/stores/pageStore.ts:77`
   - `setCurrentPage` æ–¹æ³•

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ”¯æŒåœºæ™¯åç§°
```typescript
// å½“å‰: å¿…é¡»ä½¿ç”¨ID
state_gotoscene(scene: "page-123abc")

// æœªæ¥: å¯ä»¥ä½¿ç”¨åç§°
state_gotoscene(scene: "ç¬¬ä¸€å…³")
```

### 2. æ·»åŠ è½¬åœºåŠ¨ç”»
```typescript
// æ·¡å…¥æ·¡å‡º
state_gotoscene(scene: "xxx", transition: "fade", duration: 0.5)

// æ»‘åŠ¨
state_gotoscene(scene: "xxx", transition: "slide", direction: "left")
```

### 3. åœºæ™¯å†å²è®°å½•
```typescript
// è¿”å›ä¸Šä¸€åœºæ™¯
state_goback()

// è·³è½¬å¹¶è®°å½•å†å²
state_gotoscene(scene: "xxx", pushHistory: true)
```

---

**åœºæ™¯åˆ‡æ¢åŠŸèƒ½ç°åœ¨åº”è¯¥å®Œå…¨æ­£å¸¸äº†ï¼** ğŸ®

**æµ‹è¯•æ­¥éª¤**:
1. åˆ·æ–°é¡µé¢ (Ctrl + Shift + R)
2. æ‰“å¼€F12æŸ¥çœ‹Console
3. è¿›å…¥é¢„è§ˆæ¨¡å¼
4. ç‚¹å‡»æŒ‰é’®
5. è§‚å¯ŸConsoleæ—¥å¿—å’Œåœºæ™¯åˆ‡æ¢

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·å¤åˆ¶Consoleä¸­çš„å®Œæ•´æ—¥å¿—ç»™æˆ‘ï¼
