# 图片资源刷新后失效 - 修复说明

**修复时间**: 2026-01-27 凌晨2:30
**问题**: 上传的图片在页面刷新后无法显示

## 问题根源

### ❌ 旧的实现
```typescript
// 使用 URL.createObjectURL() 创建临时 URL
const url = URL.createObjectURL(uploadFile);
// 返回类似: blob:http://localhost:3001/xxxxx
```

**问题**:
- `blob:` URL 只在当前页面会话中有效
- 页面刷新后，这些临时URL全部失效
- 无法持久化存储

### ✅ 新的实现
```typescript
// 将文件转换为 Base64 编码
const reader = new FileReader();
reader.readAsDataURL(uploadFile);
// 返回类似: data:image/png;base64,iVBORw0KGgoAAAANS...
```

**优点**:
- Base64 是文件的完整编码
- 可以持久化存储（localStorage、数据库）
- 页面刷新后仍然有效
- 不依赖外部资源

## 解决方案细节

### 修改的文件
`src/components/panels/ResourcePanel.tsx` (第85-127行)

### 关键改动

#### 之前
```typescript
const url = URL.createObjectURL(uploadFile); // ❌ 临时URL
const resource = addResource({
  path: url, // blob:http://... (刷新后失效)
});
```

#### 之后
```typescript
// 转换为 Base64
const base64Url = await new Promise<string>((resolve, reject) => {
  const reader = new FileReader();
  reader.onload = () => resolve(reader.result as string);
  reader.onerror = reject;
  reader.readAsDataURL(uploadFile);
});

const resource = addResource({
  path: base64Url, // data:image/png;base64,... (永久有效)
});
```

## 使用方法

### 1. 清理旧资源（重要！）

**旧的图片资源已经失效，需要重新上传**

```
方式1: 手动清理
- 打开资源面板
- 删除所有旧图片
- 重新上传图片

方式2: 清空存储（快速）
- 打开浏览器开发者工具 (F12)
- Console 标签
- 输入并执行:
  localStorage.clear()
  location.reload()
```

### 2. 重新上传图片

1. **访问编辑器**
   ```
   http://localhost:3001
   ```

2. **打开资源面板**
   - 左侧或右侧面板中的"资源管理"

3. **上传新图片**
   - 点击"上传"按钮
   - 选择图片文件
   - 等待上传完成

4. **使用图片**
   - 拖拽图片组件到画布
   - 或在属性面板中选择图片

### 3. 验证修复

1. **上传一张图片**
2. **在编辑器中使用该图片**
3. **刷新页面** (F5)
4. **图片应该正常显示** ✅

## Base64 vs Blob URL 对比

| 特性 | Base64 (data:) | Blob URL (blob:) |
|------|----------------|-------------------|
| 持久性 | ✅ 永久有效 | ❌ 刷新后失效 |
| 存储方式 | ✅ 可存储到localStorage | ❌ 仅内存中 |
| 文件大小 | ⚠️ 增加约33% | ✅ 无额外开销 |
| 跨页面 | ✅ 可以 | ❌ 不可以 |
| 性能 | ⚠️ 大文件较慢 | ✅ 快速 |
| 适用场景 | 小型项目、原型 | 临时预览 |

## 注意事项

### 1. 文件大小限制

Base64 会增加约33%的文件大小：
```
原始图片: 100KB
Base64 编码: 133KB
```

**建议**:
- 图片控制在 500KB 以内
- 使用压缩过的图片
- PNG/JPEG 格式

### 2. localStorage 限制

浏览器 localStorage 通常限制 5-10MB：
```
Chrome: 约 5MB
Firefox: 约 10MB
Safari: 约 5MB
```

**如果超出限制**:
```javascript
// 会抛出错误
DOMException: QuotaExceededError
```

**解决方法**:
- 压缩图片
- 删除不用的资源
- 使用服务器存储（生产环境）

### 3. 性能考虑

上传大量图片时：
```
✅ 单张小图片（<100KB）: 快速
⚠️ 多张中等图片（100-500KB）: 可接受
❌ 大图片或大量图片（>500KB）: 较慢
```

## 未来优化建议

### 短期（原型开发）
✅ **当前方案**: Base64 编码
- 简单
- 无需后端
- 适合 Demo

### 长期（生产环境）
推荐使用服务器存储：

```typescript
// 上传到服务器
const formData = new FormData();
formData.append('file', uploadFile);

const response = await fetch('/api/upload', {
  method: 'POST',
  body: formData,
});

const { url } = await response.json();
// 返回: https://cdn.example.com/images/abc123.png
```

**优点**:
- 不占用 localStorage
- 支持大文件
- 更好的性能
- 可以使用 CDN 加速

## 常见问题

### Q1: 旧图片还是显示不出来？

**原因**: 旧的 blob: URL 已失效

**解决**:
```javascript
// 清空localStorage并刷新
localStorage.clear();
location.reload();
```

然后重新上传所有图片。

### Q2: 上传后还是显示"图片加载失败"？

**检查清单**:
1. 打开 F12 → Console 查看错误
2. 检查图片格式（支持 PNG/JPEG/GIF/WEBP）
3. 检查图片大小（建议 < 500KB）
4. 确认图片文件没有损坏

### Q3: 图片显示但很模糊？

**可能原因**:
- 原图分辨率低
- 浏览器自动压缩

**解决**:
```typescript
// 在 ResourcePanel.tsx 中调整压缩质量
compressQuality: 0.9  // 提高到 0.9 (默认 0.8)
```

### Q4: 能否混用 Base64 和网络图片？

**可以！** 系统会自动识别：
```typescript
// Base64
src="data:image/png;base64,iVBORw..."

// 网络图片
src="https://example.com/image.png"

// 本地文件（相对路径）
src="/images/bg.png"
```

所有格式都能正常显示。

## 测试验证

### 测试步骤

1. **清空旧数据**
   ```javascript
   localStorage.clear();
   location.reload();
   ```

2. **上传新图片**
   - 上传一张测试图片（建议 < 200KB）

3. **使用图片**
   - 创建图片组件
   - 选择刚上传的图片

4. **刷新测试**
   - 按 F5 刷新页面
   - 图片应该正常显示

5. **预览测试**
   - 进入预览模式
   - 图片应该正常显示

### 预期结果

✅ 上传成功提示
✅ 编辑器中图片正常显示
✅ 刷新后图片仍然显示
✅ 预览模式图片正常
✅ Console 无错误

---

**修复完成！现在图片刷新后不会再失效了。** 🎉

**重要**: 请清空旧数据并重新上传图片！
